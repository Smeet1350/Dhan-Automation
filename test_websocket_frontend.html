<!DOCTYPE html>
<html>
<head>
    <title>WebSocket Test</title>
</head>
<body>
    <h1>WebSocket Test</h1>
    <button id="connectBtn">Connect</button>
    <button id="disconnectBtn">Disconnect</button>
    <div id="status">Disconnected</div>
    <div id="messages"></div>

    <script>
        let ws = null;
        const statusDiv = document.getElementById('status');
        const messagesDiv = document.getElementById('messages');
        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');

        function addMessage(message) {
            const div = document.createElement('div');
            div.textContent = new Date().toLocaleTimeString() + ': ' + message;
            messagesDiv.appendChild(div);
        }

        function connect() {
            try {
                addMessage('🔌 Connecting to WebSocket...');
                statusDiv.textContent = 'Connecting...';
                
                ws = new WebSocket('ws://localhost:8001/ws');
                
                ws.onopen = function() {
                    addMessage('✅ WebSocket connected!');
                    statusDiv.textContent = 'Connected';
                    
                    // Subscribe to channels
                    ws.send(JSON.stringify({
                        type: 'subscribe',
                        channels: ['holdings', 'positions']
                    }));
                    addMessage('📤 Sent subscription message');
                };
                
                ws.onmessage = function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        addMessage('📥 Received: ' + JSON.stringify(data));
                        
                        if (data.event === 'ping') {
                            addMessage('🔄 Ping received');
                        } else if (data.event === 'subscribed') {
                            addMessage('✅ Subscription confirmed');
                        }
                    } catch (error) {
                        addMessage('❌ Error parsing message: ' + error);
                    }
                };
                
                ws.onclose = function(event) {
                    addMessage('🔌 WebSocket disconnected: ' + event.code + ' ' + event.reason);
                    statusDiv.textContent = 'Disconnected';
                    ws = null;
                };
                
                ws.onerror = function(error) {
                    addMessage('❌ WebSocket error: ' + error);
                    statusDiv.textContent = 'Error';
                };
                
            } catch (error) {
                addMessage('❌ Failed to create WebSocket: ' + error);
                statusDiv.textContent = 'Error';
            }
        }

        function disconnect() {
            if (ws) {
                ws.close();
                ws = null;
                statusDiv.textContent = 'Disconnected';
                addMessage('🔌 Manually disconnected');
            }
        }

        connectBtn.onclick = connect;
        disconnectBtn.onclick = disconnect;
    </script>
</body>
</html>
